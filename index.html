<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç Lat/Lon ‚Üî UTM ‚Üî MGRS</title>

    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBwGrlOp-k99i4mj_q7v9uTxzXmEF9-GWM&callback=initMap"></script>

    <script src="mgrs.min.js"></script>
    <script src="proj4.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            height: 100vh;
            overflow: hidden;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .main-container {
            display: flex;
            height: 100vh;
        }

        #map {
            flex: 1;
            height: 100%;
            position: relative;
        }

        .control-panel {
            width: 420px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(15px);
            border-left: 1px solid rgba(0, 0, 0, 0.1);
            padding: 25px;
            overflow-y: auto;
            box-shadow: -5px 0 20px rgba(0, 0, 0, 0.15);
        }

        .control-panel h1 {
            font-size: 22px;
            margin-bottom: 25px;
            color: #2c3e50;
            text-align: center;
            font-weight: 600;
        }

        .input-group {
            margin-bottom: 18px;
        }

        .input-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #34495e;
            font-size: 14px;
        }

        .input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .input-group input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }

        .button-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 25px;
        }

        button {
            padding: 14px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            border-radius: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        .mgrs-section {
            margin-top: 25px;
            padding-top: 25px;
            border-top: 2px solid #ecf0f1;
        }

        .mgrs-section h3 {
            margin-bottom: 18px;
            color: #2c3e50;
            font-size: 18px;
            font-weight: 600;
        }

        .result-section {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border: 1px solid #dee2e6;
            font-size: 14px;
            line-height: 1.6;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .result-section strong {
            color: #2c3e50;
        }

        .result-section small {
            color: #6c757d;
            font-style: italic;
        }

        .map-placeholder {
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            font-weight: 600;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .map-placeholder::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="1"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
            opacity: 0.3;
        }

        .map-controls {
            position: absolute;
            top: 15px;
            left: 15px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            padding: 12px;
            border-radius: 8px;
            font-size: 13px;
            color: #6c757d;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .coordinate-marker {
            position: absolute;
            width: 20px;
            height: 20px;
            background: #e74c3c;
            border: 3px solid white;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.2); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }

        .quick-actions {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #ecf0f1;
        }

        .quick-actions h3 {
            margin-bottom: 15px;
            color: #2c3e50;
            font-size: 16px;
            font-weight: 600;
        }

        .quick-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .quick-btn {
            padding: 8px 12px;
            font-size: 12px;
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
            min-width: 80px;
        }

        .quick-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
        }

        .format-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #ecf0f1;
        }

        .format-section h3 {
            margin-bottom: 15px;
            color: #2c3e50;
            font-size: 16px;
            font-weight: 600;
        }

        .format-examples {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            font-size: 12px;
            color: #6c757d;
            line-height: 1.4;
        }

        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
            }

            #map {
                height: 40%;
            }

            .control-panel {
                width: 100%;
                height: 60%;
            }

            .map-controls {
                top: auto;
                bottom: 15px;
                left: 15px;
                right: 15px;
            }
        }

        .copy-btn {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 10px;
            transition: all 0.3s ease;
        }

        .copy-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(243, 156, 18, 0.3);
        }

        .error-message {
            color: #e74c3c;
            background: #ffebee;
            padding: 10px;
            border-radius: 6px;
            border-left: 4px solid #e74c3c;
        }

        .success-message {
            color: #27ae60;
            background: #e8f5e8;
            padding: 10px;
            border-radius: 6px;
            border-left: 4px solid #27ae60;
        }

        .utm-section {
            margin-top: 25px;
            padding-top: 25px;
            border-top: 2px solid #ecf0f1;
        }

        .utm-section h3 {
            margin-bottom: 18px;
            color: #2c3e50;
            font-size: 18px;
            font-weight: 600;
        }

        .precision-buttons {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .precision-btn {
            padding: 6px 10px;
            font-size: 11px;
            background: linear-gradient(135deg, #8e44ad, #9b59b6);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .precision-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(142, 68, 173, 0.3);
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div id="map">
            <div class="map-placeholder">
                <div>
                    <div style="margin-bottom: 10px;">üó∫Ô∏è –Ü–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞ –∫–∞—Ä—Ç–∞</div>
                    <div style="font-size: 14px; opacity: 0.8;">–ö–ª—ñ–∫–Ω—ñ—Ç—å –Ω–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ –¥–ª—è —ó—Ö –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è</div>
                </div>
            </div>
        </div>

        <div class="control-panel">
            <h1>–ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç</h1>

            <div class="input-group">
                <label for="latInput">–®–∏—Ä–æ—Ç–∞:</label>
                <input type="text" id="latInput" placeholder="50.4501" oninput="validateInput()">
            </div>

            <div class="input-group">
                <label for="lonInput">–î–æ–≤–≥–æ—Ç–∞:</label>
                <input type="text" id="lonInput" placeholder="30.5234" oninput="validateInput()">
            </div>

            <div class="button-group">
                <button onclick="convertLatLonToUTM()">‚Üí UTM</button>
                <button onclick="convertLatLonToMGRS()">‚Üí MGRS</button>
                <button onclick="convertLatLonToAll()">‚Üí UTM + MGRS</button>
                <button onclick="convertLatLonToAllPrecisions()">‚Üí MGRS (–≤—Å—ñ —Ç–æ—á–Ω–æ—Å—Ç—ñ)</button>
                <button onclick="showOnMapFromInputs()">–ü–æ–∫–∞–∑–∞—Ç–∏ –Ω–∞ –∫–∞—Ä—Ç—ñ</button>
            </div>

            <div class="utm-section">
                <h3>–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—è –∑ UTM</h3>
                <div class="input-group">
                    <label for="utmZoneInput">–ó–æ–Ω–∞ UTM:</label>
                    <input type="text" id="utmZoneInput" placeholder="36N">
                </div>
                <div class="input-group">
                    <label for="utmEastingInput">Easting:</label>
                    <input type="text" id="utmEastingInput" placeholder="123456">
                </div>
                <div class="input-group">
                    <label for="utmNorthingInput">Northing:</label>
                    <input type="text" id="utmNorthingInput" placeholder="5123456">
                </div>
                <div class="button-group">
                    <button onclick="convertUTMToLatLon()">‚Üí Lat/Lon</button>
                </div>
            </div>

            <div class="mgrs-section">
                <h3>–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—è –∑ MGRS</h3>
                <div class="input-group">
                    <label for="mgrsInput">MGRS –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏:</label>
                    <input type="text" id="mgrsInput" placeholder="36UYA1234567890" oninput="validateMGRSInput()">
                </div>
                <div class="button-group">
                    <button onclick="convertMGRSToLatLon()">‚Üí Lat/Lon</button>
                </div>
            </div>

            <div class="quick-actions">
                <h3>–®–≤–∏–¥–∫—ñ –¥—ñ—ó</h3>
                <div class="quick-buttons">
                    <button class="quick-btn" onclick="setKyivCoordinates()">–ö–∏—ó–≤</button>
                    <button class="quick-btn" onclick="setLvivCoordinates()">–õ—å–≤—ñ–≤</button>
                    <button class="quick-btn" onclick="setOdesaCoordinates()">–û–¥–µ—Å–∞</button>
                    <button class="quick-btn" onclick="clearInputs()">–û—á–∏—Å—Ç–∏—Ç–∏</button>
                    <button class="quick-btn location-btn" onclick="getCurrentLocation()">–ú–æ—î –º—ñ—Å—Ü–µ–∑–Ω–∞—Ö–æ–¥–∂–µ–Ω–Ω—è</button>
                </div>
            </div>

            <div class="format-section">
                <h3>–§–æ—Ä–º–∞—Ç–∏ –≤–≤–æ–¥—É</h3>
                <div class="format-examples">
                    <strong>Lat/Lon:</strong> 50.4501, 30.5234<br>
                    <strong>UTM:</strong> 36N 123456 5123456<br>
                    <strong>MGRS:</strong> 36UYA1234567890<br>
                    <strong>–ü—Ä–∏–∫–ª–∞–¥–∏:</strong><br>
                    ‚Ä¢ –î–µ—Å—è—Ç–∫–æ–≤—ñ –≥—Ä–∞–¥—É—Å–∏: 50.4501<br>
                    ‚Ä¢ MGRS –ø–æ–≤–Ω–∏–π: 36UYA1234567890<br>
                    ‚Ä¢ MGRS —Å–∫–æ—Ä–æ—á–µ–Ω–∏–π: 36UYA12345678
                </div>
            </div>

            <div id="result" class="result-section" style="display: none;"></div>
        </div>
    </div>

    <div class="map-controls">
        üí° –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ –±—É–¥—É—Ç—å –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω—ñ –Ω–∞ –∫–∞—Ä—Ç—ñ –ø—ñ—Å–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—ó
    </div>

    <script>
        // Global Leaflet map instance
        let map = null;
        let currentMarker = null;

        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Leaflet map
            map = L.map('map').setView([50.4501, 30.5234], 6); // Centered on Kyiv
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);

            // Define WGS84 projection for proj4js
            // This needs to be done AFTER proj4.js is loaded
            if (typeof proj4 !== 'undefined') {
                proj4.defs("EPSG:4326", "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs");
            } else {
                console.error("Proj4js library not loaded!");
                showTemporaryMessage("–ü–æ–º–∏–ª–∫–∞: –ë—ñ–±–ª—ñ–æ—Ç–µ–∫–∞ Proj4js –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∞. –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—è UTM –º–æ–∂–µ –Ω–µ –ø—Ä–∞—Ü—é–≤–∞—Ç–∏.", 'error');
            }

            // Add event listeners
            document.getElementById('latInput').addEventListener('input', validateInput);
            document.getElementById('lonInput').addEventListener('input', validateInput);
            document.getElementById('mgrsInput').addEventListener('input', validateMGRSInput);
            document.getElementById('utmZoneInput').addEventListener('input', validateUTMInput);
            document.getElementById('utmEastingInput').addEventListener('input', validateUTMInput);
            document.getElementById('utmNorthingInput').addEventListener('input', validateUTMInput);

            document.getElementById('latInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') convertLatLonToAll();
            });
            document.getElementById('lonInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') convertLatLonToAll();
            });
            document.getElementById('mgrsInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') convertMGRSToLatLon();
            });
            document.getElementById('utmZoneInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') convertUTMToLatLon();
            });
            document.getElementById('utmEastingInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') convertUTMToLatLon();
            });
            document.getElementById('utmNorthingInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') convertUTMToLatLon();
            });

            // Automatic MGRS input formatting
            document.getElementById('mgrsInput').addEventListener('input', function(e) {
                e.target.value = e.target.value.toUpperCase().replace(/[^0-9A-Z]/g, '');
            });
        });

        // Helper function to display results
        function showResult(content, isError = false) {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = content;
            resultDiv.style.display = 'block';

            if (isError) {
                resultDiv.className = 'result-section error-message';
            } else {
                resultDiv.className = 'result-section';
            }
        }

        // Helper function to add copy buttons
        function addCopyButton(text, label) {
            return `<button class="copy-btn" onclick="copyToClipboard('${text}')">${label}</button>`;
        }

        // Helper function for copy to clipboard
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(function() {
                showTemporaryMessage('–°–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ!', 'success');
            }, function() {
                showTemporaryMessage('–ü–æ–º–∏–ª–∫–∞ –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è', 'error');
            });
        }

        // Helper function for temporary messages
        function showTemporaryMessage(message, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = type === 'success' ? 'success-message' : 'error-message';
            messageDiv.textContent = message;
            messageDiv.style.position = 'fixed';
            messageDiv.style.top = '20px';
            messageDiv.style.right = '20px';
            messageDiv.style.zIndex = '9999';
            messageDiv.style.padding = '10px 20px';
            messageDiv.style.borderRadius = '8px';
            messageDiv.style.fontSize = '14px';
            messageDiv.style.fontWeight = '600';
            document.body.appendChild(messageDiv);

            setTimeout(() => {
                document.body.removeChild(messageDiv);
            }, 3000);
        }

        // Validation functions
        function validateInput() {
            const lat = document.getElementById('latInput').value;
            const lon = document.getElementById('lonInput').value;

            if (lat) {
                const latNum = parseFloat(lat);
                if (isNaN(latNum) || latNum < -90 || latNum > 90) {
                    document.getElementById('latInput').style.borderColor = '#e74c3c';
                } else {
                    document.getElementById('latInput').style.borderColor = '#27ae60'; // Valid green
                }
            } else {
                document.getElementById('latInput').style.borderColor = '#e0e0e0';
            }

            if (lon) {
                const lonNum = parseFloat(lon);
                if (isNaN(lonNum) || lonNum < -180 || lonNum > 180) {
                    document.getElementById('lonInput').style.borderColor = '#e74c3c';
                } else {
                    document.getElementById('lonInput').style.borderColor = '#27ae60'; // Valid green
                }
            } else {
                document.getElementById('lonInput').style.borderColor = '#e0e0e0';
            }
        }

        function validateMGRSInput() {
            const mgrsInput = document.getElementById('mgrsInput').value.trim().toUpperCase();
            // Basic MGRS pattern: 1-2 digits (zone), 1 letter (latitude band), 2 letters (100km square), 2-10 digits (easting/northing)
            const mgrsPattern = /^[0-9]{1,2}[A-Z][A-Z]{2}[0-9]{2,10}$/;

            if (mgrsInput) {
                if (mgrsPattern.test(mgrsInput)) {
                    document.getElementById('mgrsInput').style.borderColor = '#27ae60';
                } else {
                    document.getElementById('mgrsInput').style.borderColor = '#e74c3c';
                }
            } else {
                document.getElementById('mgrsInput').style.borderColor = '#e0e0e0';
            }
        }

        function validateUTMInput() {
            const zone = document.getElementById('utmZoneInput').value.trim();
            const easting = document.getElementById('utmEastingInput').value;
            const northing = document.getElementById('utmNorthingInput').value;

            const zonePattern = /^[0-9]{1,2}[NnSs]$/;

            if (zone) {
                if (zonePattern.test(zone)) {
                    document.getElementById('utmZoneInput').style.borderColor = '#27ae60';
                } else {
                    document.getElementById('utmZoneInput').style.borderColor = '#e74c3c';
                }
            } else {
                document.getElementById('utmZoneInput').style.borderColor = '#e0e0e0';
            }

            if (easting) {
                const eastingNum = parseFloat(easting);
                // UTM Easting typically between 100,000 and 900,000
                if (isNaN(eastingNum) || eastingNum < 100000 || eastingNum > 900000) {
                    document.getElementById('utmEastingInput').style.borderColor = '#e74c3c';
                } else {
                    document.getElementById('utmEastingInput').style.borderColor = '#27ae60';
                }
            } else {
                document.getElementById('utmEastingInput').style.borderColor = '#e0e0e0';
            }

            if (northing) {
                const northingNum = parseFloat(northing);
                // UTM Northing range depends on hemisphere, but generally large positive numbers
                if (isNaN(northingNum) || northingNum < 0 || northingNum > 10000000) { // Approx max northing
                    document.getElementById('utmNorthingInput').style.borderColor = '#e74c3c';
                } else {
                    document.getElementById('utmNorthingInput').style.borderColor = '#27ae60';
                }
            } else {
                document.getElementById('utmNorthingInput').style.borderColor = '#e0e0e0';
            }
        }

        // --- Conversion Functions (using mgrs.js and proj4.js) ---

        function getUtmProjString(zone, hemisphere) {
            const zoneNum = parseInt(zone);
            // Proj4js doesn't directly use 'N' or 'S' for hemisphere in the proj string,
            // it's implied by the false northing.
            // For northern hemisphere, false northing is 0.
            // For southern hemisphere, false northing is 10,000,000.
            const south = hemisphere.toUpperCase() === 'S' ? ' +south' : '';
            return `+proj=utm +zone=${zoneNum} +ellps=WGS84 +datum=WGS84 +units=m +no_defs${south}`;
        }

        function convertLatLonToUTM() {
            const lat = parseFloat(document.getElementById('latInput').value);
            const lon = parseFloat(document.getElementById('lonInput').value);

            if (isNaN(lat) || isNaN(lon) || lat < -90 || lat > 90 || lon < -180 || lon > 180) {
                showResult('–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å –¥—ñ–π—Å–Ω—ñ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ Lat/Lon (-90 –¥–æ 90, -180 –¥–æ 180).', true);
                return;
            }
            if (typeof proj4 === 'undefined') {
                showResult('–ü–æ–º–∏–ª–∫–∞: –ë—ñ–±–ª—ñ–æ—Ç–µ–∫–∞ Proj4js –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∞. –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—è UTM –Ω–µ–º–æ–∂–ª–∏–≤–∞.', true);
                return;
            }

            try {
                // Determine UTM zone and hemisphere for proj4js conversion
                const zone = Math.floor((lon + 180) / 6) + 1;
                const hemisphere = lat >= 0 ? 'N' : 'S';

                const utmProj = proj4(getUtmProjString(zone, hemisphere));
                const [easting, northing] = utmProj.forward([lon, lat]);

                const result = `
                    <h3>UTM –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏:</h3>
                    <p><strong>–ó–æ–Ω–∞:</strong> ${zone}${hemisphere} ${addCopyButton(`${zone}${hemisphere}`, '–ö–æ–ø—ñ—é–≤–∞—Ç–∏')}</p>
                    <p><strong>Easting:</strong> ${easting.toFixed(2)} ${addCopyButton(easting.toFixed(2), '–ö–æ–ø—ñ—é–≤–∞—Ç–∏')}</p>
                    <p><strong>Northing:</strong> ${northing.toFixed(2)} ${addCopyButton(northing.toFixed(2), '–ö–æ–ø—ñ—é–≤–∞—Ç–∏')}</p>
                `;
                showResult(result);
                showOnMap(lat, lon); // Show on map after successful conversion
            } catch (error) {
                console.error("UTM Conversion Error:", error);
                showResult(`–ü–æ–º–∏–ª–∫–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—ó Lat/Lon –≤ UTM: ${error.message}`, true);
            }
        }

        function convertLatLonToMGRS() {
            const lat = parseFloat(document.getElementById('latInput').value);
            const lon = parseFloat(document.getElementById('lonInput').value);

            if (isNaN(lat) || isNaN(lon) || lat < -90 || lat > 90 || lon < -180 || lon > 180) {
                showResult('–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å –¥—ñ–π—Å–Ω—ñ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ Lat/Lon (-90 –¥–æ 90, -180 –¥–æ 180).', true);
                return;
            }
            if (typeof mgrs === 'undefined') {
                showResult('–ü–æ–º–∏–ª–∫–∞: –ë—ñ–±–ª—ñ–æ—Ç–µ–∫–∞ MGRS –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∞. –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—è MGRS –Ω–µ–º–æ–∂–ª–∏–≤–∞.', true);
                return;
            }

            try {
                // Use the mgrs.js library for MGRS conversion
                const mgrsCoord = mgrs.forward([lon, lat], 5); // 5 for 1-meter precision by default
                const result = `
                    <h3>MGRS –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏:</h3>
                    <p><strong>MGRS:</strong> ${mgrsCoord} ${addCopyButton(mgrsCoord, '–ö–æ–ø—ñ—é–≤–∞—Ç–∏')}</p>
                `;
                showResult(result);
                showOnMap(lat, lon); // Show on map after successful conversion
            } catch (error) {
                console.error("MGRS Conversion Error (LatLon to MGRS):", error);
                showResult(`–ü–æ–º–∏–ª–∫–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—ó Lat/Lon –≤ MGRS: ${error.message}`, true);
            }
        }

        function convertLatLonToAll() {
            const lat = parseFloat(document.getElementById('latInput').value);
            const lon = parseFloat(document.getElementById('lonInput').value);

            if (isNaN(lat) || isNaN(lon) || lat < -90 || lat > 90 || lon < -180 || lon > 180) {
                showResult('–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å –¥—ñ–π—Å–Ω—ñ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ Lat/Lon (-90 –¥–æ 90, -180 –¥–æ 180).', true);
                return;
            }
            if (typeof proj4 === 'undefined' || typeof mgrs === 'undefined') {
                showResult('–ü–æ–º–∏–ª–∫–∞: –ù–µ –≤—Å—ñ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω—ñ. –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—è –Ω–µ–º–æ–∂–ª–∏–≤–∞.', true);
                return;
            }

            try {
                // UTM
                const zone = Math.floor((lon + 180) / 6) + 1;
                const hemisphere = lat >= 0 ? 'N' : 'S';
                const utmProj = proj4(getUtmProjString(zone, hemisphere));
                const [easting, northing] = utmProj.forward([lon, lat]);

                // MGRS
                const mgrsCoord = mgrs.forward([lon, lat], 5);

                const result = `
                    <h3>–í—Å—ñ —Ñ–æ—Ä–º–∞—Ç–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç:</h3>
                    <p><strong>–®–∏—Ä–æ—Ç–∞:</strong> ${lat.toFixed(6)}¬∞ ${addCopyButton(lat.toFixed(6), '–ö–æ–ø—ñ—é–≤–∞—Ç–∏')}</p>
                    <p><strong>–î–æ–≤–≥–æ—Ç–∞:</strong> ${lon.toFixed(6)}¬∞ ${addCopyButton(lon.toFixed(6), '–ö–æ–ø—ñ—é–≤–∞—Ç–∏')}</p>
                    <p><strong>UTM:</strong> ${zone}${hemisphere} ${easting.toFixed(2)} ${northing.toFixed(2)} ${addCopyButton(`${zone}${hemisphere} ${easting.toFixed(2)} ${northing.toFixed(2)}`, '–ö–æ–ø—ñ—é–≤–∞—Ç–∏')}</p>
                    <p><strong>MGRS:</strong> ${mgrsCoord} ${addCopyButton(mgrsCoord, '–ö–æ–ø—ñ—é–≤–∞—Ç–∏')}</p>
                `;
                showResult(result);
                showOnMap(lat, lon); // Show on map after successful conversion
            } catch (error) {
                console.error("All Conversions Error:", error);
                showResult(`–ü–æ–º–∏–ª–∫–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—ó: ${error.message}`, true);
            }
        }

        function convertLatLonToAllPrecisions() {
            const lat = parseFloat(document.getElementById('latInput').value);
            const lon = parseFloat(document.getElementById('lonInput').value);

            if (isNaN(lat) || isNaN(lon) || lat < -90 || lat > 90 || lon < -180 || lon > 180) {
                showResult('–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å –¥—ñ–π—Å–Ω—ñ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ Lat/Lon (-90 –¥–æ 90, -180 –¥–æ 180).', true);
                return;
            }
            if (typeof mgrs === 'undefined') {
                showResult('–ü–æ–º–∏–ª–∫–∞: –ë—ñ–±–ª—ñ–æ—Ç–µ–∫–∞ MGRS –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∞. –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—è MGRS –Ω–µ–º–æ–∂–ª–∏–≤–∞.', true);
                return;
            }

            try {
                let result = '<h3>MGRS –∑ —Ä—ñ–∑–Ω–æ—é —Ç–æ—á–Ω—ñ—Å—Ç—é:</h3>';
                // Precision in MGRS is 0-5. 0 for 100km, 1 for 10km, ..., 5 for 1m
                for (let precision = 0; precision <= 5; precision++) {
                    const mgrsCoord = mgrs.forward([lon, lat], precision);
                    const resolutionText = ['100–∫–º', '10–∫–º', '1–∫–º', '100–º', '10–º', '1–º'][precision];
                    result += `<p><strong>${resolutionText} (${precision} —Ü–∏—Ñ—Ä):</strong> ${mgrsCoord} ${addCopyButton(mgrsCoord, '–ö–æ–ø—ñ—é–≤–∞—Ç–∏')}</p>`;
                }
                showResult(result);
                showOnMap(lat, lon); // Show on map after successful conversion
            } catch (error) {
                console.error("MGRS All Precisions Conversion Error:", error);
                showResult(`–ü–æ–º–∏–ª–∫–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—ó Lat/Lon –≤ MGRS (–≤—Å—ñ —Ç–æ—á–Ω–æ—Å—Ç—ñ): ${error.message}`, true);
            }
        }

        function convertUTMToLatLon() {
            const zoneStr = document.getElementById('utmZoneInput').value.trim();
            const easting = parseFloat(document.getElementById('utmEastingInput').value);
            const northing = parseFloat(document.getElementById('utmNorthingInput').value);

            if (!zoneStr || isNaN(easting) || isNaN(northing)) {
                showResult('–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å –≤—Å—ñ UTM –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ (–ó–æ–Ω–∞, Easting, Northing).', true);
                return;
            }
            if (typeof proj4 === 'undefined') {
                showResult('–ü–æ–º–∏–ª–∫–∞: –ë—ñ–±–ª—ñ–æ—Ç–µ–∫–∞ Proj4js –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∞. –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—è UTM –Ω–µ–º–æ–∂–ª–∏–≤–∞.', true);
                return;
            }

            const zoneMatch = zoneStr.match(/^(\d+)([NnSs])$/);
            if (!zoneMatch) {
                showResult('–ù–µ–∫–æ—Ä–µ–∫—Ç–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç –∑–æ–Ω–∏ UTM (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, 36N –∞–±–æ 34s).', true);
                return;
            }

            const zoneNum = parseInt(zoneMatch[1]);
            const hemisphere = zoneMatch[2].toUpperCase();

            try {
                const utmProj = proj4(getUtmProjString(zoneNum, hemisphere));
                const [lon, lat] = utmProj.inverse([easting, northing]);

                if (isNaN(lat) || isNaN(lon) || lat < -90 || lat > 90 || lon < -180 || lon > 180) {
                    showResult('–û—Ç—Ä–∏–º–∞–Ω—ñ Lat/Lon –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ –ø–æ–∑–∞ –¥–æ–ø—É—Å—Ç–∏–º–∏–º–∏ –º–µ–∂–∞–º–∏. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –≤–≤—ñ–¥ UTM.', true);
                    return;
                }

                const result = `
                    <h3>Lat/Lon –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏:</h3>
                    <p><strong>–®–∏—Ä–æ—Ç–∞:</strong> ${lat.toFixed(6)}¬∞ ${addCopyButton(lat.toFixed(6), '–ö–æ–ø—ñ—é–≤–∞—Ç–∏')}</p>
                    <p><strong>–î–æ–≤–≥–æ—Ç–∞:</strong> ${lon.toFixed(6)}¬∞ ${addCopyButton(lon.toFixed(6), '–ö–æ–ø—ñ—é–≤–∞—Ç–∏')}</p>
                `;
                showResult(result);
                showOnMap(lat, lon); // Show on map after successful conversion
            } catch (error) {
                console.error("UTM to LatLon Conversion Error:", error);
                showResult(`–ü–æ–º–∏–ª–∫–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—ó UTM –≤ Lat/Lon: ${error.message}`, true);
            }
        }

        function convertMGRSToLatLon() {
            const mgrsCoord = document.getElementById('mgrsInput').value.trim();

            if (!mgrsCoord) {
                showResult('–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å MGRS –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏.', true);
                return;
            }
            if (typeof mgrs === 'undefined') {
                showResult('–ü–æ–º–∏–ª–∫–∞: –ë—ñ–±–ª—ñ–æ—Ç–µ–∫–∞ MGRS –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∞. –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—è MGRS –Ω–µ–º–æ–∂–ª–∏–≤–∞.', true);
                return;
            }
            
            // Basic MGRS pattern validation (more robust validation is inside mgrs.js)
            const mgrsPattern = /^[0-9]{1,2}[A-Z][A-Z]{2}[0-9]*$/;
            if (!mgrsPattern.test(mgrsCoord)) {
                showResult('–ù–µ–∫–æ—Ä–µ–∫—Ç–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç MGRS (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, 36UYA1234567890).', true);
                return;
            }

            try {
                // Use the mgrs.js library for MGRS to Lat/Lon conversion
                const [lon, lat] = mgrs.inverse(mgrsCoord);

                if (isNaN(lat) || isNaN(lon) || lat < -90 || lat > 90 || lon < -180 || lon > 180) {
                    showResult('–û—Ç—Ä–∏–º–∞–Ω—ñ Lat/Lon –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ –ø–æ–∑–∞ –¥–æ–ø—É—Å—Ç–∏–º–∏–º–∏ –º–µ–∂–∞–º–∏. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –≤–≤—ñ–¥ MGRS.', true);
                    return;
                }

                const result = `
                    <h3>Lat/Lon –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏:</h3>
                    <p><strong>–®–∏—Ä–æ—Ç–∞:</strong> ${lat.toFixed(6)}¬∞ ${addCopyButton(lat.toFixed(6), '–ö–æ–ø—ñ—é–≤–∞—Ç–∏')}</p>
                    <p><strong>–î–æ–≤–≥–æ—Ç–∞:</strong> ${lon.toFixed(6)}¬∞ ${addCopyButton(lon.toFixed(6), '–ö–æ–ø—ñ—é–≤–∞—Ç–∏')}</p>
                `;
                showResult(result);
                showOnMap(lat, lon); // Show on map after successful conversion
            } catch (error) {
                console.error("MGRS to LatLon Conversion Error:", error);
                showResult(`–ü–æ–º–∏–ª–∫–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—ó MGRS –≤ Lat/Lon: ${error.message}`, true);
            }
        }

        // --- Quick Actions ---

        function setKyivCoordinates() {
            document.getElementById('latInput').value = '50.4501';
            document.getElementById('lonInput').value = '30.5234';
            validateInput();
            convertLatLonToAll(); // Automatically convert and show on map
        }

        function setLvivCoordinates() {
            document.getElementById('latInput').value = '49.8397';
            document.getElementById('lonInput').value = '24.0297';
            validateInput();
            convertLatLonToAll(); // Automatically convert and show on map
        }

        function setOdesaCoordinates() {
            document.getElementById('latInput').value = '46.4825';
            document.getElementById('lonInput').value = '30.7233';
            validateInput();
            convertLatLonToAll(); // Automatically convert and show on map
        }

        function clearInputs() {
            document.getElementById('latInput').value = '';
            document.getElementById('lonInput').value = '';
            document.getElementById('mgrsInput').value = '';
            document.getElementById('utmZoneInput').value = '';
            document.getElementById('utmEastingInput').value = '';
            document.getElementById('utmNorthingInput').value = '';
            document.getElementById('result').style.display = 'none';

            // Reset border colors
            document.getElementById('latInput').style.borderColor = '#e0e0e0';
            document.getElementById('lonInput').style.borderColor = '#e0e0e0';
            document.getElementById('mgrsInput').style.borderColor = '#e0e0e0';
            document.getElementById('utmZoneInput').style.borderColor = '#e0e0e0';
            document.getElementById('utmEastingInput').style.borderColor = '#e0e0e0';
            document.getElementById('utmNorthingInput').style.borderColor = '#e0e0e0';

            // Remove marker from map
            if (currentMarker) {
                map.removeLayer(currentMarker);
                currentMarker = null;
            }
             // Show the map placeholder again
             document.querySelector('.map-placeholder').style.display = 'flex';
        }

        function showOnMapFromInputs() {
            const lat = parseFloat(document.getElementById('latInput').value);
            const lon = parseFloat(document.getElementById('lonInput').value);

            if (isNaN(lat) || isNaN(lon) || lat < -90 || lat > 90 || lon < -180 || lon > 180) {
                showResult('–°–ø–æ—á–∞—Ç–∫—É –≤–≤–µ–¥—ñ—Ç—å –¥—ñ–π—Å–Ω—ñ Lat/Lon –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏, —â–æ–± –ø–æ–∫–∞–∑–∞—Ç–∏ —ó—Ö –Ω–∞ –∫–∞—Ä—Ç—ñ.', true);
                return;
            }
            showOnMap(lat, lon);
            showResult(`–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ ${lat.toFixed(6)}, ${lon.toFixed(6)} –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–æ –Ω–∞ –∫–∞—Ä—Ç—ñ`);
        }

        // Function to display marker on the map
        function showOnMap(lat, lon) {
            if (!map) {
                showResult('–ö–∞—Ä—Ç–∞ –Ω–µ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–∞. –°–ø—Ä–æ–±—É–π—Ç–µ –æ–Ω–æ–≤–∏—Ç–∏ —Å—Ç–æ—Ä—ñ–Ω–∫—É.', true);
                return;
            }

            // Remove previous marker
            if (currentMarker) {
                map.removeLayer(currentMarker);
            }

            // Create new marker
            currentMarker = L.marker([lat, lon]).addTo(map);
            currentMarker.bindPopup(`
                <b>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏:</b><br>
                –®–∏—Ä–æ—Ç–∞: ${lat.toFixed(6)}¬∞<br>
                –î–æ–≤–≥–æ—Ç–∞: ${lon.toFixed(6)}¬∞
            `).openPopup();

            // Center map on marker and zoom
            map.setView([lat, lon], 13);

            // Hide the placeholder
            document.querySelector('.map-placeholder').style.display = 'none';
        }

        function getCurrentLocation() {
            if (!navigator.geolocation) {
                showResult('–ì–µ–æ–ª–æ–∫–∞—Ü—ñ—è –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î—Ç—å—Å—è —Ü–∏–º –±—Ä–∞—É–∑–µ—Ä–æ–º', true);
                return;
            }

            const button = document.querySelector('.location-btn');
            const originalText = button.textContent;
            button.textContent = '–û—Ç—Ä–∏–º–∞–Ω–Ω—è...';
            button.disabled = true;

            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;

                    document.getElementById('latInput').value = lat.toFixed(6);
                    document.getElementById('lonInput').value = lon.toFixed(6);

                    // Automatically convert and show all formats
                    convertLatLonToAll();

                    button.textContent = originalText;
                    button.disabled = false;
                    showTemporaryMessage('–ü–æ—Ç–æ—á–Ω–µ –º—ñ—Å—Ü–µ–∑–Ω–∞—Ö–æ–¥–∂–µ–Ω–Ω—è –æ—Ç—Ä–∏–º–∞–Ω–æ', 'success');
                },
                function(error) {
                    let errorMessage = '–ü–æ–º–∏–ª–∫–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –≥–µ–æ–ª–æ–∫–∞—Ü—ñ—ó';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage = '–î–æ—Å—Ç—É–ø –¥–æ –≥–µ–æ–ª–æ–∫–∞—Ü—ñ—ó –∑–∞–±–æ—Ä–æ–Ω–µ–Ω–æ. –ë—É–¥—å –ª–∞—Å–∫–∞, –¥–æ–∑–≤–æ–ª—å—Ç–µ –¥–æ—Å—Ç—É–ø –¥–æ –≥–µ–æ–ª–æ–∫–∞—Ü—ñ—ó –≤ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è—Ö –±—Ä–∞—É–∑–µ—Ä–∞.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage = '–ú—ñ—Å—Ü–µ–∑–Ω–∞—Ö–æ–¥–∂–µ–Ω–Ω—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–µ. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑ –ø—ñ–∑–Ω—ñ—à–µ.';
                            break;
                        case error.TIMEOUT:
                            errorMessage = '–ß–∞—Å –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è –≥–µ–æ–ª–æ–∫–∞—Ü—ñ—ó –≤–∏—á–µ—Ä–ø–∞–Ω–æ. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –∑\'—î–¥–Ω–∞–Ω–Ω—è –∞–±–æ —Å–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.';
                            break;
                    }
                    showResult(errorMessage, true);
                    button.textContent = originalText;
                    button.disabled = false;
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        }
    </script>
</body>
</html>
